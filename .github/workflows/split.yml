name: split
on:
  workflow_dispatch:
  push:
    branches: [ split ]
  pull_request:
    branches: [ split ]
jobs:
  toolchain:
    name: toolchain
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: false
    - name: Set env variables
      uses: ./g/github/env/
    - run: sudo apt-get install libgmp-dev libmpfr-dev libmpc-dev gettext libtool-bin
    - run: make -j13 toolchain/binutils-gdb/binutils-gdb{checkout} toolchain/gcc/gcc{checkout} userspace/glibc/glibc{checkout} linux/linux{checkout}
    - run: make -j13 done/toolchain/binutils-gdb/install done/linux/headers/install done/userspace/glibc/headers/install done/toolchain/gcc/gcc/install
    - run: make -j13 build/toolchain.tar.zstd{artifact}
  qemu:
    name: qemu
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: false
    - name: Set env variables
      uses: ./g/github/env/
    - run: sudo apt-get install meson ninja-build
    - run: make -j13 build/qemu.tar.zstd{artifact}
  debian:
    name: debian
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: false
    - name: Set env variables
      uses: ./g/github/env/
    - run: sudo apt-get install qemu-system-aarch64
    - run: make build/debian.cpio.zstd{artifact}
  userspace:
    name: userspace
    needs: toolchain
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: false
    - name: Set env variables
      uses: ./g/github/env/
    - run: sudo apt-get install qemu-user qemu-user-static binfmt-support autopoint gettext
    - run: make build/artifacts/down/toolchain.tar.zstd{}
    - run: tar -xf build/artifacts/down/toolchain.tar.zstd
    - run: rm -f done/userspace/glibc/checkout
    - run: make build/userspace.tar.zstd{artifact}
  linux:
    name: linux
    needs: toolchain
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: false
    - name: Set env variables
      uses: ./g/github/env/
    - run: make build/artifacts/down/toolchain.tar.zstd{}
    - run: tar -xf build/artifacts/down/toolchain.tar.zstd
    - run: make build/linux.tar.zstd{artifact}
  bootloaders:
    name: bootloaders
    needs: toolchain
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: false
    - name: Set env variables
      uses: ./g/github/env/
    - run: sudo apt-get install autopoint lzop
    - run: make build/artifacts/down/toolchain.tar.zstd{}
    - run: tar -xf build/artifacts/down/toolchain.tar.zstd
    - run: make build/bootloaders.tar.zstd{artifact}
  bootloaders1:
    name: bootloaders1
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: false
    - name: Set env variables
      uses: ./g/github/env/
    - run: sudo apt-get install autopoint lzop
    - run: make build/released/pipcet/pearl-toolchain/toolchain.tar.zstd{}
    - run: tar -xf build/released/pipcet/pearl-toolchain/toolchain.tar.zstd
    - run: make build/bootloaders.tar.zstd
    - run: cp build/bootloaders.tar.zstd build/bootloaders1.tar.zstd
    - run: make build/bootloaders1.tar.zstd{artifact}
  pearl:
    name: pearl
    needs: [ toolchain, linux, bootloaders, userspace ]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: false
    - name: Set env variables
      uses: ./g/github/env/
    - run: make build/artifacts/down/toolchain.tar.zstd{}
    - run: tar -xf build/artifacts/down/toolchain.tar.zstd
    - run: make build/artifacts/down/linux.tar.zstd{}
    - run: tar -xf build/artifacts/down/linux.tar.zstd
    - run: make build/artifacts/down/bootloaders.tar.zstd{}
    - run: tar -xf build/artifacts/down/bootloaders.tar.zstd
    - run: make build/artifacts/down/userspace.tar.zstd{}
    - run: tar -xf build/artifacts/down/userspace.tar.zstd
    - run: make build/pearl.tar.zstd{artifact}
  pearl-debian:
    name: pearl-debian
    needs: [ toolchain, linux, bootloaders, userspace, pearl, debian ]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: false
    - name: Set env variables
      uses: ./g/github/env/
    - run: make build/artifacts/down/toolchain.tar.zstd{}
    - run: tar -xf build/artifacts/down/toolchain.tar.zstd
    - run: make build/artifacts/down/linux.tar.zstd{}
    - run: tar -xf build/artifacts/down/linux.tar.zstd
    - run: make build/artifacts/down/bootloaders.tar.zstd{}
    - run: tar -xf build/artifacts/down/bootloaders.tar.zstd
    - run: make build/artifacts/down/userspace.tar.zstd{}
    - run: tar -xf build/artifacts/down/userspace.tar.zstd
    - run: make build/artifacts/down/pearl.tar.zstd{}
    - run: tar -xf build/artifacts/down/pearl.tar.zstd
    - run: make build/artifacts/down/debian.tar.zstd{}
    - run: tar -xf build/artifacts/down/debian.tar.zstd
    - run: make -j13 build/pearl-debian-uncompressed.macho.zst.image{artifact}
  video-uboot:
    name: video-uboot
    needs: [ toolchain, bootloaders, qemu ]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: false
    - name: Set env variables
      uses: ./g/github/env/
    - run: make build/artifacts/down/toolchain.tar.zstd{}
    - run: tar -xf build/artifacts/down/toolchain.tar.zstd
    - run: make build/artifacts/down/bootloaders.tar.zstd{}
    - run: tar -xf build/artifacts/down/bootloaders.tar.zstd
    - run: make build/artifacts/down/qemu.tar.zstd{}
    - run: tar -xf build/artifacts/down/qemu.tar.zstd
    - run: sudo apt-get install ffmpeg netpbm socat
    - run: touch --reference=done/bootloaders/barebox/configure bootloaders/barebox/barebox.config
    - run: touch --reference=done/bootloaders/u-boot/configure bootloaders/u-boot/u-boot.config
    - run: make build/video/u-boot.mp4{artifact}
  video-barebox:
    name: video-barebox
    needs: [ toolchain, bootloaders, qemu ]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: false
    - name: Set env variables
      uses: ./g/github/env/
    - run: make build/artifacts/down/toolchain.tar.zstd{}
    - run: tar -xf build/artifacts/down/toolchain.tar.zstd
    - run: make build/artifacts/down/bootloaders.tar.zstd{}
    - run: tar -xf build/artifacts/down/bootloaders.tar.zstd
    - run: make build/artifacts/down/qemu.tar.zstd{}
    - run: tar -xf build/artifacts/down/qemu.tar.zstd
    - run: sudo apt-get install ffmpeg netpbm socat
    - run: touch --reference=done/bootloaders/barebox/configure bootloaders/barebox/barebox.config
    - run: touch --reference=done/bootloaders/u-boot/configure bootloaders/u-boot/u-boot.config
    - run: make build/video/barebox.mp4{artifact}
  video-barebox1:
    name: video-barebox1
    needs: [ bootloaders1, qemu ]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: false
    - name: Set env variables
      uses: ./g/github/env/
    - run: make build/released/pipcet/pearl-toolchain/toolchain.tar.zstd{}
    - run: tar -xf build/released/pipcet/pearl-toolchain/toolchain.tar.zstd
    - run: make build/artifacts/down/bootloaders1.tar.zstd{}
    - run: tar -xf build/artifacts/down/bootloaders1.tar.zstd
    - run: make build/artifacts/down/qemu.tar.zstd{}
    - run: tar -xf build/artifacts/down/qemu.tar.zstd
    - run: sudo apt-get install ffmpeg netpbm socat
    - run: touch --reference=done/bootloaders/barebox/configure bootloaders/barebox/barebox.config
    - run: touch --reference=done/bootloaders/u-boot/configure bootloaders/u-boot/u-boot.config
    - run: make build/video/barebox.mp4
    - run: cp build/video/barebox.mp4 build/video/barebox1.mp4
    - run: make build/video/barebox1.mp4{artifact}
  video-pearl:
    name: video-pearl
    needs: [ toolchain, pearl, qemu ]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: false
    - name: Set env variables
      uses: ./g/github/env/
    - run: make build/artifacts/down/toolchain.tar.zstd{}
    - run: tar -xf build/artifacts/down/toolchain.tar.zstd
    - run: make build/artifacts/down/pearl.tar.zstd{}
    - run: tar -xf build/artifacts/down/pearl.tar.zstd
    - run: make build/artifacts/down/qemu.tar.zstd{}
    - run: tar -xf build/artifacts/down/qemu.tar.zstd
    - run: sudo apt-get install ffmpeg netpbm socat
    - run: make build/video/pearl.mp4{artifact}
  video-debian:
    name: video-debian
    needs: [ toolchain, pearl-debian, qemu ]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: false
    - name: Set env variables
      uses: ./g/github/env/
    - run: make build/artifacts/down/toolchain.tar.zstd{}
    - run: tar -xf build/artifacts/down/toolchain.tar.zstd
    - run: make build/artifacts/down/pearl.tar.zstd{}
    - run: tar -xf build/artifacts/down/pearl-debian-uncompressed.macho.zst.image{}
    - run: mv build/artifacts/down/pearl-debian-uncompressed.macho.zst.image build/
    - run: make build/artifacts/down/qemu.tar.zstd{}
    - run: tar -xf build/artifacts/down/qemu.tar.zstd
    - run: sudo apt-get install ffmpeg netpbm socat
    - run: make build/video/pearl-debian.mp4{artifact}
